# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_stats.ipynb.

# %% auto 0
__all__ = ['rally', 'players', 'game', 'team', 'get_first_serve_team', 'get_team_names', 'get_team_ids', 'summarize_game',
           'team_first_serve_win_frac', 'get_frac_first_serve_wins', 'get_player_id_from_name', 'get_teams_from_player',
           'games_played_by_team']

# %% ../nbs/02_stats.ipynb 3
from .data import *

# %% ../nbs/02_stats.ipynb 4
rally = get_tab_as_df("rally")
players = get_tab_as_df("player")
game = get_tab_as_df("game")
team = get_tab_as_df("team")

# %% ../nbs/02_stats.ipynb 6
def get_first_serve_team(game_id: str):
    '''
    Returns the team_id of the team that served first for a given game with game_id.
    '''
    return rally[(rally.game_id == game_id) & (rally.rally_nbr == 1)].srv_team_id.values[0]

# %% ../nbs/02_stats.ipynb 9
def get_team_names(team_id: str):
    '''
    Returns the name of the team with team_id
    '''
    return team[team.team_id == team_id].team_nm.values[0]

# %% ../nbs/02_stats.ipynb 12
def get_team_ids(game_id: str):
    '''
    Returns the team_ids of the teams that played a given game with game_id with the winning
    team returned first
    '''
    return game[game.game_id == game_id].w_team_id.values[0], game[game.game_id == game_id].l_team_id.values[0]
    
def summarize_game(game_id: str):
    w_team_id, l_team_id = get_team_ids(game_id_test)
    w_team_nm, l_team_nm = get_team_names(w_team_id), get_team_names(l_team_id)
    w_team_score, l_team_score = game[game.game_id == game_id].score_w.values[0], game[game.game_id == game_id].score_l.values[0]
    print(f"{w_team_nm} beat {l_team_nm} in game {game_id} by a score of {w_team_score} to {l_team_score}")

# %% ../nbs/02_stats.ipynb 15
def team_first_serve_win_frac(team_id):
    '''
    Takes a team id and returns that team's first serve win percentage.
    '''
    # Get all rallies where the team served the first rally of the game
    rally_fs_df = rally[(rally.rally_nbr == 1) & (rally.srv_team_id == team_id)]
    num_first_serves = len(rally_fs_df)
    #Find the number of games won by the team when they served first
    num_first_serve_games_won = sum(game[game.game_id.isin(rally_fs_df.game_id)].w_team_id == team_id)
    if num_first_serves == 0:
        return 0
    else:
        return num_first_serve_games_won/num_first_serves

# %% ../nbs/02_stats.ipynb 20
def get_frac_first_serve_wins(game_df):
    '''
    Returns the fraction of games won by the first searver for a given df of games.
    '''
    count = 0
    for game_id in game_df.game_id:
        if (game_df[game_df.game_id == game_id].w_team_id == get_first_serve_team(game_id)).values[0]:
            count +=1 
    return count/len(game_df)

# %% ../nbs/02_stats.ipynb 23
def get_player_id_from_name(player_name: str):
    '''
    Returns the player_id of a player with player_name.
    '''
    first, last = player_name.split(' ')[0], player_name.split(' ')[1]
    name_mask = (players.first_nm.str.lower() == first.lower()) & (players.last_nm.str.lower() == last.lower())
    if max(name_mask) == False:
        print("Player not found")
        return None
    else:
        return players[name_mask].player_id.values[0]

def get_teams_from_player(player_id: str):
    '''
    Returns the team_ids of the teams that a player with player_id played for.
    '''
    return team[team.player_id == player_id].team_id.values

# %% ../nbs/02_stats.ipynb 26
def games_played_by_team(team_id):
    '''
    Returns the number of games played by a team with team_id.
    '''
    return len(game[(game.w_team_id == team_id) | (game.l_team_id == team_id)])
